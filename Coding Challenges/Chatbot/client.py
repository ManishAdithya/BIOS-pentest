import socket
from cryptography.fernet import Fernet
import hashlib
import hmac
import os

def generate_key():
    return Fernet.generate_key()

def encrypt_message(key, message):
    cipher = Fernet(key)
    encrypted_message = cipher.encrypt(message.encode())
    return encrypted_message

def decrypt_message(key, encrypted_message):
    cipher = Fernet(key)
    decrypted_message = cipher.decrypt(encrypted_message).decode()
    return decrypted_message

def calculate_sha256(data):
    sha256 = hashlib.sha256()
    sha256.update(data)
    return sha256.digest()

def calculate_hmac(key, data):
    h = hmac.new(key, data, hashlib.sha512)
    return h.digest()

def start_client():
    host = '127.0.0.1'
    port = 12345

    client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client_socket.connect((host, port))

    key = client_socket.recv(1024)
    hmac_key = client_socket.recv(32)

    try:
        while True:
            message = input("Enter your message: ")
            encrypted_message = encrypt_message(key, message)
            client_socket.sendall(encrypted_message)
            client_socket.sendall(calculate_sha256(encrypted_message))
            client_socket.sendall(calculate_hmac(hmac_key, encrypted_message))

            data = client_socket.recv(4096)
            received_sha256 = client_socket.recv(32)
            received_hmac = client_socket.recv(32)
            decrypted_response = decrypt_message(key, data)

            if received_sha256 != calculate_sha256(decrypted_response.encode()):
                print("Integrity check failed. Message may have been tampered with.")
            elif received_hmac != calculate_hmac(hmac_key, data):
                print("HMAC verification failed. Message may not be authentic.")
            else:
                print(f"Server response: {decrypted_response}")

    except KeyboardInterrupt:
        print("Exited by user")

    client_socket.close()

if __name__ == "__main__":
    start_client()
